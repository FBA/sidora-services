<?xml version="1.0" encoding="UTF-8"?>

<blueprint xmlns="http://www.osgi.org/xmlns/blueprint/v1.0.0"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xmlns:cm="http://aries.apache.org/blueprint/xmlns/blueprint-cm/v1.1.0"
    xsi:schemaLocation="
http://www.osgi.org/xmlns/blueprint/v1.0.0 http://www.osgi.org/xmlns/blueprint/v1.0.0/blueprint.xsd">

    <!-- OSGI blueprint property placeholder -->
    <cm:property-placeholder id="system.placeholder" persistent-id="camel.blueprint" />

    <bean id="pidAggregator" class="edu.smithsonian.services.fedorarepo.aggregators.PidAggregationStrategy" />
    
    <!--
        TODO: Add Deployment Metadata backport
    -->
    <camelContext xmlns="http://camel.apache.org/schema/blueprint" >

        <!-- using Camel properties component and refer to the blueprint property placeholder by its id -->
        <propertyPlaceholder id="properties" 
                             location="blueprint:system.placeholder,file:${karaf.home}/etc/system.properties"/>
        
        <route id="CameraTrapStartProcessing">
            <from uri="file:Process?moveFailed=Error_CamelTrap&amp;delete=true"/>
            <log message="Starting Camera Trap Process" /> 
            <!--If issue with large archives can 'slow' down the route with delay below-->
            <delay>
                <constant>3000</constant>
            </delay>
            <log message="Starting Extraction" />
            <to uri="extractor:extract?location=CameraTrapData" />
            <log message="Finished Extraction" />
            <transform>
                <simple>deployment_manifest.xml</simple>
            </transform>
            <to uri="reader:file?type=text" />
            <to uri="direct:process" />
            <log message="Finished Data processing!" />
        </route>
        <route id="CameraTrapProcessData">
            <from uri="direct:process" />
            <log message="Starting Data processing... " />
            <setHeader headerName="CamelFedoraLabel">
                <xpath resultType="java.lang.String">//CameraSiteName</xpath>
            </setHeader>
            <setHeader headerName="ManifestXML"><simple>${body}</simple></setHeader>
            <!-- <log message="SiteLabel - ${header.CamelFedoraLabel}" /> -->
            <to uri="fedora:create?owner={{si.fedora.default.owner}}&amp;namespace={{si.fedora.default.namespace}}" />
            <multicast>
                <to uri="direct:manifest" />
                <to uri="direct:fgdc" />
                <!-- Researcher Observations are a resource object like the images --> 
                <!-- <to uri="direct:researcher" /> -->
                <!-- Volunteer Observations are a resource object like the images -->
                <!-- <to uri="direct:volunteer" /> -->
                <to uri="direct:processImages" />
            </multicast>
            <log message="Finished Data processing!" /> 
        </route>
        <route id="CameraTrapTransformManifest" >
            <from uri="direct:manifest" />
            <to uri="fedora:datastream?name=MANIFEST&amp;type=text/xml&amp;group=M" />
            <log message="Added Manifest DataStream" /> 
        </route>
        <route id="CameraTrapAddFGDCDatastream" >
            <from uri="direct:fgdc" />
            <!-- <log message="${in.body}" /> -->
            <to uri="xslt:file:Input/xslt/amazon_map1.xsl"/>
            <to uri="xslt:file:Input/xslt/amazon_map2.xsl"/>
            <to uri="xslt:file:Input/xslt/amazon_map3.xsl"/>
            <to uri="fedora:datastream?name=FGDC&amp;type=text/xml&amp;group=M" />
            <log message="Added FGDC DataStream" />
        </route>
        <route id="CameraTrapTransformResearcherData" >
            <from uri="direct:researcher" />
            <setHeader headerName="CamelFedoraLabel">
                <simple>researcher_observation.csv</simple>
            </setHeader>
            <setBody><simple>${header.ManifestXML}</simple></setBody>
            <to uri="fedora:create?pid=null&amp;owner={{si.fedora.default.owner}}&amp;namespace={{si.fedora.default.namespace}}" />
            <to uri="xslt:file:Input/xslt/researcher.xsl" />
            <transform>
                <xpath>//researcher/text()</xpath>
            </transform>
            <to uri="fedora:datastream?name=RESEARCHER&amp;type=text/csv&amp;group=M" />
            <log message="Researcher's Observation resource created" />
        </route>
        <route id="CameraTrapTransformVolunteerData" >
            <from uri="direct:volunteer" />
            <setHeader headerName="CamelFedoraLabel">
                <simple>volunteer_observation.csv</simple>
            </setHeader>
            <setBody><simple>${header.ManifestXML}</simple></setBody>
            <to uri="fedora:create?pid=null&amp;owner={{si.fedora.default.owner}}&amp;namespace={{si.fedora.default.namespace}}" />
            <to uri="xslt:file:Input/xslt/volunteer.xsl"/>
            <transform>
                <xpath>//researcher/text()</xpath>
            </transform>
            <to uri="fedora:datastream?name=VOLUNTEER&amp;type=text/csv&amp;group=M" />
            <log message="Volunteer's Observation file created" /> 
        </route>
        <route id="CameraTrapProcessImages" >
            <from uri="direct:processImages" /> 
            <log message="Starting Image processing..." />
            <log message="Resource1 - ${body}" />
            <setHeader headerName="FedoraParentConcept">
                <simple>${header.CamelFedoraPid}</simple>
            </setHeader>
            <log message="Parent PID - ${header.CamelFedoraPid} and ${header.FedoraParentConcept}" />
            <!-- <setBody><simple>Default</simple></setBody> -->
            <!-- <log message="Resource2 - ${body}" /> -->
            <split strategyRef="pidAggregator" >
                <xpath>//ImageFileName/text()</xpath>
                <setHeader headerName="CamelFedoraLabel">
                    <simple>${body}</simple>
                </setHeader>
                <to uri="reader:file" />
                <to uri="fedora:create?pid=null&amp;owner={{si.fedora.default.owner}}&amp;namespace={{si.fedora.default.namespace}}" />
                <to uri="fedora:datastream?name=OBJ&amp;type=image/jpeg&amp;group=M" />
                <!-- <to uri="direct:transformImage" /> -->
            </split>
            
            <to uri="direct:researcher" />
            <log message="${header.CamelFedoraPid}" />
            <setHeader headerName="PIDAggregation">
                <simple>${header.PIDAggregation},${header.CamelFedoraPid}</simple>
            </setHeader>
            <log message="Aggregation: ${header.PIDAggregation}" />

            <to uri="direct:volunteer" />
            <log message="${header.CamelFedoraPid}" />
            <setHeader headerName="PIDAggregation">
                <simple>${header.PIDAggregation},${header.CamelFedoraPid}</simple>
            </setHeader>
            <log message="Aggregation: ${header.PIDAggregation}" />

            <!--
                FIXME: Change FedoraRepo to use 'FedoraParentConcept' instead of 'CamelParentConcept'
                Pointless to store and unstore the parent PID
            -->
            <!-- <log message="Resource2 - ${body}" /> -->
            <setHeader headerName="CamelFedoraPid">
                <simple>${header.FedoraParentConcept}</simple>
            </setHeader>
            <to uri="velocity:file:Input/templates/CameraTrapResourceTemplate.vsl" />
            <to uri="fedora:datastream?name=RELS-EXT" /> 
            <log message="Finished processing Images" />           
        </route>
        <route id="CameraTrapTransformImages">
            <from uri="direct:transformImage" />
            <!--<multicast>-->
                <to uri="direct:createThumbnail" />
                <!--<to uri="direct:createResampled" />-->
                <!--
                    TODO: Add FITS component to route
                -->
            <!--</multicast>-->
            <log message="Image processed" />
        </route>
        <route id="CameraTrapCreateThumbnailImage" >
            <from uri="direct:createThumbnail" />
            <to uri="thumbnailator:image?keepRatio=false&amp;size=(72,96)"/>
            <to uri="fedora:datastream?name=TN&amp;type=image/jpeg&amp;group=M" />
        </route>
        <route id="CameraTrapCreateResampledImage">
            <from uri="direct:createResampled" />
            <!--
                NOTE: This might not be needed

                FIXME: Figure out what the Drush scripts are doing to 'normalized'
                      the image. Based on conversation with Dan didn't sound like
                      it was changing the quality of the original
                FIXME: If 'normalized' image is needed and should be the same
                       size as the original, remove size requirement from route
            -->
            <to uri="thumbnailator:image?quality=80%&amp;size=(2048,1536)"/>
            <to uri="file://CameraTrapOutput/resample" />
        </route>
    </camelContext>
        
</blueprint>