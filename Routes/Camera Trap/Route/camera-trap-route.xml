<?xml version="1.0" encoding="UTF-8"?>

<blueprint xmlns="http://www.osgi.org/xmlns/blueprint/v1.0.0"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xmlns:cm="http://aries.apache.org/blueprint/xmlns/blueprint-cm/v1.1.0"
    xsi:schemaLocation="http://www.osgi.org/xmlns/blueprint/v1.0.0 http://www.osgi.org/xmlns/blueprint/v1.0.0/blueprint.xsd">

    <!-- OSGI blueprint property placeholder -->
    <cm:property-placeholder id="system.placeholder" persistent-id="camel.blueprint"/>

    <bean id="pidAggregator" class="edu.si.services.fedorarepo.aggregators.PidAggregationStrategy"/>

    <bean id="noRootObject" class="java.lang.IllegalArgumentException">
        <argument value="CameraTrapIngest: Root object does not exist."/>
    </bean>

    <bean id="cameraTrapRoutes" class="edu.si.services.beans.cameratrap.CameraTrapRouteBuilder"/>

    <bean id="velocityToolsHandler" class="edu.si.services.beans.velocityToolsHandler.VelocityToolsHandler"/>

    
    <!-- errorHandlerRef="ctingestErrorHandler" -->

    <camelContext id="CTIngestCamelContext"
                  xmlns="http://camel.apache.org/schema/blueprint"
                  xmlns:ri="http://www.w3.org/2001/sw/DataAccess/rf1/result" 
                  xmlns:fits="http://hul.harvard.edu/ois/xml/ns/fits/fits_output"
                  trace="false">

        <!--
          The "unused" namespace definitions above are needed to deal with the way Camel handles namespaces in XPath.
        -->
        <!-- Using a Camel properties component and referring to the blueprint property placeholder by its ID. -->
        <propertyPlaceholder id="properties"
                             location="blueprint:system.placeholder,file:${karaf.home}/etc/system.properties"/>

        <!--
        <errorHandler id="ctingestErrorHandler" type="DefaultErrorHandler">
            <redeliveryPolicy maximumRedeliveries="20"
                              retryAttemptedLogLevel="WARN"
                              backOffMultiplier="2"
                              useExponentialBackOff="true"/>
        </errorHandler>
        -->

        <routeBuilder ref="cameraTrapRoutes"/>

        <onException>
            <exception>java.net.ConnectException</exception>
            <redeliveryPolicy useExponentialBackOff="true"
                              backOffMultiplier="2"
                              redeliveryDelay="1000"
                              maximumRedeliveries="200"
                              retryAttemptedLogLevel="WARN"/>
        </onException>

        <route id="CameraTrapStartProcessing">
            <from uri="file:Process?moveFailed=Error_CamelTrap&amp;delete=true"/>
            <log message="${id} CameraTrapIngest: Starting Camera Trap processing ..."
                 loggingLevel="INFO"
                 logName="edu.si.ctingest"/>

            <!-- Needed for the Velocity tools. -->
            <setHeader headerName="esc">
                <method ref="velocityToolsHandler" method="getVelocityEscapeTool"/>
            </setHeader>

            <!--If there is an issue with staging large archives we can can 'slow' down the route with delay below. -->
            <delay>
                <constant>6000</constant>
            </delay>

            <log message="${id} CameraTrapIngest: Starting Extraction"/>
            <to uri="extractor:extract?location=CameraTrapData"/>
            <log message="${id} CameraTrapIngest: Finished Extraction"/>
            <transform>
                <simple>deployment_manifest.xml</simple>
            </transform>
            <to uri="reader:file?type=text"/>
            <to uri="validator:file:Input/schemas/DeploymentManifest.xsd"/>

            <!-- Add Schematron validation. -->
            <!-- <to uri="schematron:///home/davisda/Projects/sidora/sem/apache-servicemix-5.4.0/Input/schemas/DeploymentManifest2014.sch"/> -->
            <!--
            <to uri="schematron:///opt/sidora/servicemix/Input/schemas/DeploymentManifest2014.sch"/>
            <log message="${id} CameraTrapIngest: Schematron Validation Status - ${header.CamelSchematronValidationStatus}"
                 loggingLevel="INFO"/>
            -->

            <!-- Add image count and filename check. -->
            <setHeader headerName="ManifestXML">
                <simple>
                    ${body}
                </simple>
            </setHeader>
            <to uri="direct:validatePackage"/>

            <to uri="direct:processPackage"/>
            <log message="${id} CameraTrapIngest: Finished Camera Trap processing!"
                 loggingLevel="INFO"
                 logName="edu.si.ctingest"/>
        </route>

        <route id="CameraTrapValidatePackage">
            <from uri="direct:validatePackage"/>
            <log message="${id} CameraTrapIngest: Starting Package validation ..."
                 loggingLevel="INFO"
                 logName="edu.si.ctingest"/>

            <split>
                <xpath headerName="ManifestXML">
                    //ImageFileName/text()
                </xpath>
                <log message="${id} CameraTrapIngest: Split Resource - ${body}"
                     loggingLevel="DEBUG"
                     logName="edu.si.ctingest"/>
                <setHeader headerName="ImageFileName">
                    <simple resultType="java.lang.String">
                        ${body}
                    </simple>
                </setHeader>
                <setHeader headerName="ImageSequenceID">
                    <xpath logNamespaces="false" resultType="java.lang.String" headerName="ManifestXML">
                        //ImageFileName[text()=$ImageFileName]/parent::Image/parent::ImageSequence/ImageSequenceId/text()
                    </xpath>
                </setHeader>
                <log message="${id} CameraTrapIngest: ImageSequenceID - ${header.ImageSequenceID}"
                     loggingLevel="DEBUG"
                     logName="edu.si.ctingest"/>
                <!-- This throws a java.io.FileNotFoundException if the file does not exist. -->
                <to uri="reader:file"/>
                <log message="${id} CameraTrapIngest: CamelSplitSize - ${property.CamelSplitSize} CamelSplitIndex - ${property.CamelSplitIndex}"
                     loggingLevel="DEBUG"
                     logName="edu.si.ctingest"/>
                <!-- We should check the image count to see if it exactly matches the image file count. -->
            </split>

            <log message="${id} CameraTrapIngest: Finished Package validation."
                 loggingLevel="INFO"
                 logName="edu.si.ctingest"/>
        </route>
        
        <route id="CameraTrapProcessPackage">
            <from uri="direct:processPackage"/>
            <log message="${id} CameraTrapIngest: Starting Package processing..."
                 loggingLevel="INFO"
                 logName="edu.si.ctingest"/>

            <to uri="direct:processParents"/>
            <to uri="direct:processSite"/>

            <log message="${id} CameraTrapIngest: Finished Package processing."
                 loggingLevel="INFO"
                 logName="edu.si.ctingest"/>
        </route>
        
        <route id="CameraTrapProcessSite">
            <from uri="direct:processSite"/>
            <log message="${id} CameraTrapIngest: Starting Site processing... "
                 loggingLevel="INFO"
                 logName="edu.si.ctingest"/>

            <!-- Stash the parent PID which could be a Plot or a Sub-project. -->
            <setHeader headerName="ParentPID">
                <simple>
                    ${header.CamelFedoraPid}
                </simple>
            </setHeader>
            <setHeader headerName="CamelFedoraLabel">
                <xpath resultType="java.lang.String" headerName="ManifestXML">
                    //CameraSiteName
                </xpath>
            </setHeader>
            <to uri="fedora:create?pid=null&amp;owner={{si.ct.owner}}&amp;namespace={{si.ct.namespace}}"/>
            <log message="${id} CameraTrapIngest: Add Relation: Parent PID - ${header.ParentPID} Child PID - ${header.CamelFedoraPid}"
                 loggingLevel="DEBUG"
                 logName="edu.si.ctingest"/>
            <to uri="fedora:hasConcept?parentPid=${header.ParentPID}&amp;childPid=${header.CamelFedoraPid}"/>
            <log message="${id} CameraTrapIngest: Add Relation: Status - ${header.CamelFedoraStatus}"
                 loggingLevel="DEBUG"
                 logName="edu.si.ctingest"/>
            <setBody>
                <simple>
                    ${header.ManifestXML}
                </simple>
            </setBody>
            <multicast>
                <to uri="direct:addManifestDataStream"/>
                <to uri="direct:addFGDCDataStream"/>
                <to uri="direct:processResources"/>
            </multicast>

            <log message="${id} CameraTrapIngest: Finished Site processing."
                 loggingLevel="INFO"
                 logName="edu.si.ctingest"/>
        </route>
        
        <route id="CameraTrapAddManifestDataStream">
            <from uri="direct:addManifestDataStream"/>
            <log message="${id} CameraTrapIngest: Starting Manifest processing ..."
                 loggingLevel="INFO"
                 logName="edu.si.ctingest"/>

            <to uri="fedora:addDatastream?name=MANIFEST&amp;type=text/xml&amp;group=M&amp;dsLabel=MANIFEST"/>

            <log message="${id} CameraTrapIngest: Finished Manifest processing."
                 loggingLevel="INFO"
                 logName="edu.si.ctingest"/>
        </route>
        
        <route id="CameraTrapAddFGDCDataStream">
            <from uri="direct:addFGDCDataStream"/>
            <log message="${id} CameraTrapIngest: Starting FGDC processing ..."
                 loggingLevel="INFO"
                 logName="edu.si.ctingest"/>

            <to uri="xslt:file:Input/xslt/amazon_map1.xsl"/>
            <to uri="xslt:file:Input/xslt/amazon_map2.xsl"/>
            <to uri="xslt:file:Input/xslt/amazon_map3.xsl"/>
            <to uri="fedora:addDatastream?name=FGDC&amp;type=text/xml&amp;group=M&amp;dsLabel=FGDC%20Record"/>

            <log message="${id} CameraTrapIngest: Finished FGDC processing."
                 loggingLevel="INFO"
                 logName="edu.si.ctingest"/>
        </route>
        
        <route id="CameraTrapProcessResources">
            <from uri="direct:processResources"/>
            <log message="${id} CameraTrapIngest: Starting resource processing ..."
                 loggingLevel="INFO"
                 logName="edu.si.ctingest"/>

            <setHeader headerName="SitePID">
                <simple>
                    ${header.CamelFedoraPid}
                </simple>
            </setHeader>
            <setHeader headerName="ImageCount">
                <xpath resultType="java.lang.String">
                    count(//ImageFileName)
                </xpath>
            </setHeader>
            <log message="${id} CameraTrapIngest: Site PID - ${header.SitePID}  Image Count - ${header.ImageCount}"
                 loggingLevel="INFO"
                 logName="edu.si.ctingest"/>

            <!-- There may be several kinds of resources with zero or more instances. -->
            <split strategyRef="pidAggregator">
                <xpath headerName="ManifestXML">
                    //ImageFileName/text()
                </xpath>
                <log message="${id} CameraTrapIngest: Split Resource - ${body}"
                     loggingLevel="INFO"
                     logName="edu.si.ctingest"/>
                <setBody>
                    <simple resultType="java.lang.String">
                        ${body}
                    </simple>
                </setBody>
                <to uri="direct:addImageResource"/>
                <log message="${id} CameraTrapIngest: Created Image Resource - ${body}."
                     loggingLevel="DEBUG"
                     logName="edu.si.ctingest"/>
                <log message="${id} CameraTrapIngest: CamelSplitSize - ${property.CamelSplitSize} CamelSplitIndex - ${property.CamelSplitIndex}"
                     loggingLevel="INFO"
                     logName="edu.si.ctingest"/>
            </split>

            <!-- There is only one observation resource of each kine and all the observations are aggregated. -->
            <to uri="direct:addResearcherResource"/>
            <to uri="direct:addVolunteerResource"/>

            <!-- Add the RELS-EXT datastream in one operation to gain about 70% of the total efficiency. -->
            <to uri="velocity:file:Input/templates/CTSiteTemplate.vsl"/>
            <recipientList>
                <simple>
                    fedora:addDatastream?pid=${header.SitePID}&amp;name=RELS-EXT&amp;group=X&amp;dsLabel=RDF%20Statements%20about%20this%20object&amp;versionable=false
                </simple>
            </recipientList>

            <log message="${id} CameraTrapIngest: Finished resource processing."
                 loggingLevel="INFO"
                 logName="edu.si.ctingest"/>
        </route>
        
        <route id="CameraTrapAddImageResource" trace="true">
            <from uri="direct:addImageResource"/>
            <log message="${id} CameraTrapIngest: Started Image processing ..."
                 loggingLevel="INFO"
                 logName="edu.si.ctingest"/>

            <setHeader headerName="ImageID">
                <xpath logNamespaces="false" resultType="java.lang.String" headerName="ManifestXML">
                    //ImageFileName[text()=$in:body]/parent::Image/ImageId/text()
                </xpath>
            </setHeader>
            <!-- Image Sequence ID used in MODS datastream. -->
            <setHeader headerName="ImageSequenceID">
                <xpath logNamespaces="false" resultType="java.lang.String" headerName="ManifestXML">
                    //ImageFileName[text()=$in:body]/parent::Image/parent::ImageSequence/ImageSequenceId/text()
                </xpath>
            </setHeader>
            <!--
            <setHeader headerName="ImageSequenceIndex">
                <xpath logNamespaces="false" resultType="java.lang.Integer" headerName="ManifestXML">
                    count(//Image/ImageId[.=$ImageID]/../preceding-sibling::Image)
                </xpath>
            </setHeader>
            -->
            <setHeader headerName="ImageSequenceIndex">
                <xpath logNamespaces="false" resultType="java.lang.Integer" headerName="ManifestXML">
                    substring-after($ImageID,concat($ImageSequenceID,'i'))
                </xpath>
            </setHeader>
            <setHeader headerName="ImageSequenceCount">
                <xpath logNamespaces="false" resultType="java.lang.Integer" headerName="ManifestXML">
                    count(//Image[../ImageSequenceId=$ImageSequenceID])
                </xpath>
            </setHeader>
            <log message="${id} CameraTrapIngest: Label - ${body}  ImageID - ${header.ImageID}  ImageSequenceIndex - ${header.ImageSequenceIndex}"
                 loggingLevel="DEBUG"
                 logName="edu.si.ctingest"/>
            <log message="${id} CameraTrapIngest: Label - ${body}  ImageSequenceID - ${header.ImageSequenceID}  ImageSequenceCount - ${header.ImageSequenceCount}"
                 loggingLevel="DEBUG"
                 logName="edu.si.ctingest"/>
            <to uri="reader:file"/>
            <recipientList>
                <simple>
                    fedora:create?pid=null&amp;owner={{si.ct.owner}}&amp;namespace={{si.ct.namespace}}&amp;label=${header.ImageID}
                </simple>
            </recipientList>
            <recipientList>
                <simple>
                    fedora:addDatastream?name=OBJ&amp;type=image/jpeg&amp;group=M&amp;dsLabel=${header.ImageID}&amp;versionable=false
                </simple>
            </recipientList>
            <!--<multicast>-->
            <to uri="direct:createThumbnail"/>
            <!-- <to uri="direct:createArchivalImage" /> -->
            <!-- We may also want a DISPLAY datastream. -->
            <!--</multicast>-->
            <to uri="velocity:file:Input/templates/CTImageResourceTemplate.vsl"/>
            <to uri="fedora:addDatastream?name=RELS-EXT&amp;group=X&amp;dsLabel=RDF%20Statements%20about%20this%20object&amp;versionable=false"/>
            <to uri="direct:addFITSDataStream"/>
            <to uri="direct:addMODSDataStream"/>

            <!-- The current route only handles JPG. -->
            <choice>
                <!-- If the image is a JPEG? Do nothing. -->
                <when>
                    <simple>
                        ${header.dsMIME} == 'image/jpg' || ${header.dsMIME} == 'image/jpeg' || ${header.dsMIME} == 'image/jpe'
                    </simple>
                    <log message="${id} Derivatives: Found JPEG."
                         loggingLevel="DEBUG"
                         logName="edu.si.ctingest"/>
                    <!-- Future: Make a JPEG2000 archival image and store it in the MASTER datastream. -->
                </when>
                <!-- Just warn for now. -->
                <otherwise>
                    <log message="${id} Derivatives: Found non-JPEG Image."
                         loggingLevel="WARN"
                         logName="edu.si.ctingest"/>
                </otherwise>
            </choice>

            <log message="${id} CameraTrapIngest: Finished Image processing."
                 loggingLevel="INFO"
                 logName="edu.si.ctingest"/>
        </route>

        <route id="CameraTrapAddResearcherResource">
            <from uri="direct:addResearcherResource"/>
            <log message="${id} CameraTrapIngest: Starting Researcher's data processing ..."
                 loggingLevel="INFO"
                 logName="edu.si.ctingest"/>

            <!-- When there are Researcher observations. -->
            <setBody>
                <simple>
                    ${header.ManifestXML}
                </simple>
            </setBody>
            <to uri="fedora:create?pid=null&amp;owner={{si.ct.owner}}&amp;namespace={{si.ct.namespace}}&amp;label=Researcher%20Observations"/>
            <log message="Research Observation Resource PID - ${header.CamelFedoraPid}"
                    loggingLevel="DEBUG"
                    logName="edu.si.ctingest"/>
            <setHeader headerName="PIDAggregation">
                <simple>${header.PIDAggregation},${header.CamelFedoraPid}</simple>
            </setHeader>
            <log message="Aggregation: ${header.PIDAggregation}"
                 loggingLevel="DEBUG"
                 logName="edu.si.ctingest"/>
            <to uri="xslt:file:Input/xslt/researcher.xsl"/>
            <transform>
                <xpath>
                    //researcher/text()
                </xpath>
            </transform>
            <recipientList>
                <simple>
                    fedora:addDatastream?name=OBJ&amp;type=text/csv&amp;group=M&amp;dsLabel=Researcher%20Observations&amp;versionable=false"
                </simple>
            </recipientList>
            <to uri="fedora:addDatastream?name=CSV&amp;type=text/csv&amp;group=M&amp;dsLabel=CSV&amp;versionable=false"/>
            <to uri="velocity:file:Input/templates/CTDatasetResourceTemplate.vsl"/>
            <to uri="fedora:addDatastream?name=RELS-EXT&amp;group=X&amp;dsLabel=RDF%20Statements%20about%20this%20object&amp;versionable=false"/>

            <log message="${id} CameraTrapIngest: Finished Researcher's data processing."
                 loggingLevel="INFO"
                 logName="edu.si.ctingest"/>
        </route>

        <route id="CameraTrapAddVolunteerResource">
            <from uri="direct:addVolunteerResource"/>
            <log message="${id} CameraTrapIngest: Starting Volunteer's data processing ..."
                 loggingLevel="INFO"
                 logName="edu.si.ctingest"/>

            <!-- When there are Volunteer observations. -->
            <setBody>
                <simple>
                    ${header.ManifestXML}
                </simple>
            </setBody>
            <to uri="fedora:create?pid=null&amp;owner={{si.ct.owner}}&amp;namespace={{si.ct.namespace}}&amp;label=Volunteer%20Observations"/>
            <log message="Volunteer Observation Resource PID - ${header.CamelFedoraPid}"
                 loggingLevel="DEBUG"
                 logName="edu.si.ctingest"/>
            <setHeader headerName="PIDAggregation">
                <simple>${header.PIDAggregation},${header.CamelFedoraPid}</simple>
            </setHeader>
            <log message="Aggregation: ${header.PIDAggregation}"
                 loggingLevel="DEBUG"
                 logName="edu.si.ctingest"/>
            <setBody>
                <simple>
                    ${header.ManifestXML}
                </simple>
            </setBody>
            <to uri="xslt:file:Input/xslt/volunteer.xsl"/>
            <transform>
                <xpath>
                    //researcher/text()
                </xpath>
            </transform>
            <recipientList>
                <simple>
                    fedora:addDatastream?name=OBJ&amp;type=text/csv&amp;group=M&amp;dsLabel=Volunteer%20Observations&amp;versionable=false"
                </simple>
            </recipientList>
            <to uri="fedora:addDatastream?name=CSV&amp;type=text/csv&amp;group=M&amp;dsLabel=CSV&amp;versionable=false"/>
            <to uri="velocity:file:Input/templates/CTDatasetResourceTemplate.vsl" />
            <to uri="fedora:addDatastream?name=RELS-EXT&amp;group=X&amp;dsLabel=RDF%20Statements%20about%20this%20object&amp;versionable=false"/>

            <log message="${id} CameraTrapIngest: Finished Volunteer's data processing."
                 loggingLevel="INFO"
                 logName="edu.si.ctingest"/>
        </route>

        <route id="CameraTrapAddFITSDataStream">
            <from uri="direct:addFITSDataStream"/>
            <log message="${id} CameraTrapIngest: Started processing FITS ..."
                 loggingLevel="INFO"
                 logName="edu.si.ctingest"/>

            <recipientList>
                <simple>
                    exec:fits?args=-i ${header.CamelFileAbsolutePath}
                </simple>
            </recipientList>
            <choice>
                <!-- If FITS processing succeeded? Store a FITS datastream on the FDO. -->
                <when>
                    <simple>
                        ${header.CamelExecExitValue} == 0
                    </simple>
                    <setHeader headerName="dsMIME">
                        <xpath resultType="java.lang.String">/fits:fits/fits:identification/fits:identity[1]/@mimetype</xpath>
                        <log message="${id} CameraTrapIngest: FITS MIME: ${header.FITSmimeType}"
                             loggingLevel="DEBUG"
                             logName="edu.si.ctingest"/>
                    </setHeader>
                    <log message="${id} CameraTrapIngest: Exec FITS. BODY: ${body}"
                         loggingLevel="DEBUG"
                         logName="edu.si.ctingest"/>
                    <to uri="fedora:addDatastream?name=FITS&amp;type=text/xml&amp;dsLabel=FITS%20Generated%20Image%20Metadata&amp;group=X&amp;versionable=false"/>
                </when>
                <otherwise>
                    <log message="${id} CameraTrapIngest: FITS processing failed. PID: ${header.CamelFedoraPid}  Error Code: ${header.CamelExecExitValue}"
                         loggingLevel="ERROR"/>
                </otherwise>
            </choice>

            <log message="${id} CameraTrapIngest: Finished processing FITS."
                 loggingLevel="INFO"
                 logName="edu.si.ctingest"/>
        </route>

        <route id="CameraTrapAddMODSDataStream">
            <from uri="direct:addMODSDataStream"/>
            <log message="${id} CameraTrapIngest: Started processing MODS ..."
                 loggingLevel="INFO"
                 logName="edu.si.ctingest"/>

            <!--
            <setHeader headerName="esc">
                <method ref="velocityToolsHandler" method="getVelocityEscapeTool"/>
            </setHeader>
            -->

            <!-- Get the FITS XML and use XPATH to get the created date from it. -->
            <setHeader headerName="FITSCreatedDate">
                <xpath logNamespaces="false" resultType="java.lang.String">
                    //fits:fileinfo/fits:created[@toolname="Exiftool"]
                </xpath>
            </setHeader>
            
            <!--
            <log message="MODS FITS Created Date - ${header.FITSCreatedDate}"/>
            -->

            <!-- TODO - The Image ID has .JPG appended and we may want to make this consistent. -->
            <to uri="velocity:file:Input/templates/CTImageResourceMODSTemplate.vsl"/>
            <to uri="fedora:addDatastream?name=MODS&amp;type=text/xml&amp;group=X&amp;dsLabel=MODS%20Record"/>

            <log message="${id} CameraTrapIngest: Finished processing MODS."
                 loggingLevel="INFO"
                 logName="edu.si.ctingest"/>
        </route>

        <route id="CameraTrapCreateThumbnailImage">
            <from uri="direct:createThumbnail"/>
            <log message="${id} CameraTrapIngest: Started creating thumbnail ..."
                 loggingLevel="INFO"
                 logName="edu.si.ctingest"/>

            <to uri="thumbnailator:image?keepRatio=true&amp;size=(200,150)"/>
            <to uri="fedora:addDatastream?name=TN&amp;type=image/jpeg&amp;group=M&amp;dsLabel=Thumbnail&amp;versionable=false"/>

            <log message="${id} CameraTrapIngest: Finished creating thumbnail."
                 loggingLevel="INFO"
                 logName="edu.si.ctingest"/>
        </route>
        
        <route id="CameraTrapCreateArchivalImage">
            <from uri="direct:createArchivalImage"/>
            <log message="${id} CameraTrapIngest: Started creating archival image ..."
                 loggingLevel="INFO"
                 logName="edu.si.ctingest"/>

            <!--
                NOTE: This is planned to be a JPEG 2000 but we are not doing it yet.
            <to uri="thumbnailator:image?quality=80%&amp;size=(2048,1536)"/>
            <to uri="file://CameraTrapOutput/resample"/>
            -->

            <log message="${id} CameraTrapIngest: Finished creating archival image."
                 loggingLevel="INFO"
                 logName="edu.si.ctingest"/>
        </route>
        
        <route id="CameraTrapProcessParents">
            <from uri="direct:processParents"/>
            <log message="${id} CameraTrapIngest: Started processing parents ..."
                 loggingLevel="INFO"
                 logName="edu.si.ctingest"/>

            <setBody>
                <simple>
                    {{si.ct.root}}
                </simple>
            </setBody>
            <!-- Check if the root exists, else quit. -->
            <to uri="direct:findObjectByPIDPredicate"/>
            <choice>
                <when>
                    <simple>
                        ${body} == 'true'
                    </simple>
                    <log message="${id} CameraTrapIngest: Root object exists."
                         loggingLevel="DEBUG"
                         logName="edu.si.ctingest"/>
                    <setHeader headerName="CamelFedoraPid">
                        <simple>
                            {{si.ct.root}}
                        </simple>
                    </setHeader>
                    <!-- Add the parents if needed. -->
                    <to uri="direct:processProject"/>
                    <to uri="direct:processSubproject"/>
                    <!-- Plot is optional. -->
                    <filter>
                        <xpath resultType="java.lang.String" headerName="ManifestXML">
                            boolean(//PlotName/text()[1])
                        </xpath>
                        <to uri="direct:processPlot"/>
                    </filter>
                </when>
                <otherwise>
                    <!-- Stop processing this deployment. -->
                    <log message="${id} CameraTrapIngest: Root object does not exist."
                         loggingLevel="WARN"
                         logName="edu.si.ctingest"/>
                    <throwException ref="noRootObject"/>
                </otherwise>
            </choice>

            <log message="${id} CameraTrapIngest: Finished processing parents."
                 loggingLevel="INFO"
                 logName="edu.si.ctingest"/>
        </route>
        
        <route id="CameraTrapFindObject">
            <from uri="direct:findObject"/>
            <log message="${id} CameraTrapIngest: Started find object ..."
                 loggingLevel="INFO"
                 logName="edu.si.ctingest"/>
            <log message="${id} CameraTrapIngest: Find: Label - ${body}  Parent - ${header.CamelFedoraPid}"
                 loggingLevel="INFO"
                 logName="edu.si.ctingest"/>

            <setBody>
                <!-- The query needs to also check directly along the parent axis since names are not unique. -->
                <simple>
                    SELECT ?o FROM &lt;#ri&gt;
                    WHERE
                    {
                        ?o &lt;fedora-model:label&gt; '${body}' .
                        &lt;info:fedora/${header.CamelFedoraPid}&gt; &lt;info:fedora/fedora-system:def/relations-external#hasConcept&gt; ?o .
                    }
                </simple>
            </setBody>
            <log message="${id} CameraTrapIngest: Project Parent - ${body}"
                 loggingLevel="DEBUG"
                 logName="edu.si.ctingest"/>
            <to uri="fedora:search?lang=sparql&amp;type=tuples&amp;format=sparql"/>
            <log message="${id} CameraTrapIngest: Query Result - ${body}"
                 loggingLevel="DEBUG"
                 logName="edu.si.ctingest"/>
            <!-- Count the results. If greater than one warn about duplicate parents. -->
            <choice>
                <when>
                    <xpath>
                        count(/ri:sparql/ri:results/ri:result) > 1
                    </xpath>
                    <log message="${id} CameraTrapIngest: Warning - Duplicate parents."
                         loggingLevel="WARN"
                         logName="edu.si.ctingest"/>
                </when>
            </choice>
            <setBody>
                <xpath logNamespaces="false" resultType="java.lang.String">
                    substring-after(/ri:sparql/ri:results/ri:result[1]/ri:o/@uri,'/')
                </xpath>
            </setBody>

            <log message="${id} CameraTrapIngest: Finished find object."
                 loggingLevel="INFO"
                 logName="edu.si.ctingest"/>
        </route>

        <route id="CameraTrapFindObjectByPIDPredicate">
            <from uri="direct:findObjectByPIDPredicate"/>
            <log message="${id} CameraTrapIngest: Started find object by PID ..."
                 loggingLevel="INFO"
                 logName="edu.si.ctingest"/>

            <!-- Return true in the body if the object exists for the PID, false if not. -->
            <setBody>
                <simple>
                    ASK FROM &lt;#ri&gt;
                    {
                        &lt;info:fedora/${body}&gt; ?p ?o .
                    }
                </simple>
            </setBody>
            <log message="${id} CameraTrapIngest: Find Query - ${body}"
                 loggingLevel="DEBUG"
                 logName="edu.si.ctingest"/>
            <to uri="fedora:search?lang=sparql&amp;type=tuples&amp;format=sparql"/>
            <log message="${id} CameraTrapIngest: Find Query Result - ${body}"
                 loggingLevel="DEBUG"
                 logName="edu.si.ctingest"/>
            <setBody>
                <xpath logNamespaces="false" resultType="java.lang.String">
                    /ri:sparql/ri:results/ri:result[1]/ri:k0/text()
                </xpath>
            </setBody>
            <log message="Find Object By PID - ${body}."
                 loggingLevel="DEBUG"
                 logName="edu.si.ctingest"/>

            <log message="${id} CameraTrapIngest: Finished find object by PID."
                 loggingLevel="INFO"
                 logName="edu.si.ctingest"/>
        </route>

        <route id="CameraTrapProcessPlot">
            <from uri="direct:processPlot"/>
            <log message="${id} CameraTrapIngest: Started processing plot ..."
                 loggingLevel="INFO"
                 logName="edu.si.ctingest"/>

            <!--
            <setHeader headerName="esc">
                <method ref="velocityToolsHandler" method="getVelocityEscapeTool"/>
            </setHeader>
            -->

            <!-- Look for the plot (its optional). -->
            <setBody>
                <xpath resultType="java.lang.String" headerName="ManifestXML">
                    concat(//SubProjectName/text(), ':', //PlotName/text())
                </xpath>
            </setBody>
            <setHeader headerName="CamelFedoraLabel">
                <simple>
                    ${body}
                </simple>
            </setHeader>
            <log message="${id} CameraTrapIngest: Plot: Label - ${body}  Parent PID - ${header.CamelFedoraPid}"
                 loggingLevel="DEBUG"
                 logName="edu.si.ctingest"/>
            <to uri="direct:findObject" />
            <choice>
                <when>
                    <simple>
                        ${body} == ''
                    </simple>
                    <log message="${id} CameraTrapIngest: Plot does not exist"
                         loggingLevel="DEBUG"
                         logName="edu.si.ctingest"/>
                    <!-- Stash the sub-project PID. -->
                    <setHeader headerName="ParentPID">
                        <simple>
                            ${header.CamelFedoraPid}
                        </simple>
                    </setHeader>
                    <!-- Create CT plot and add it as a sub-concept of the sub-project -->
                    <to uri="fedora:create?pid=null&amp;owner={{si.ct.owner}}&amp;namespace={{si.ct.namespace}}"/>
                    <!-- Add a minimal RELS-EXT to the project -->
                    <to uri="velocity:file:Input/templates/CTPlotTemplate.vsl"/>
                    <to uri="fedora:addDatastream?name=RELS-EXT&amp;group=X&amp;dsLabel=RDF%20Statements%20about%20this%20object&amp;versionable=false"/>
                    <!-- Add Relation from parent CT sub-project to the child CT plot -->
                    <to uri="fedora:hasConcept?parentPid=${header.ParentPID}&amp;childPid=${header.CamelFedoraPid}"/>
                    <to uri="velocity:file:Input/templates/CTPlotFGDC-CTPlotTemplate.vsl"/>
                    <to uri="fedora:addDatastream?name=FGDC-CTPlot&amp;type=text/xml&amp;group=X&amp;dsLabel=FGDC-CTPlot%20Record&amp;versionable=true"/>
                </when>
                <otherwise>
                    <!-- Return the existing plot as the current object. -->
                    <log message="${id} CameraTrapIngest: Plot already exists - ${body}."
                         loggingLevel="DEBUG"
                         logName="edu.si.ctingest"/>
                    <setHeader headerName="CamelFedoraPid">
                        <simple>
                            ${body}
                        </simple>
                    </setHeader>
                </otherwise>
            </choice>

            <log message="${id} CameraTrapIngest: Finished processing plot."
                 loggingLevel="INFO"
                 logName="edu.si.ctingest"/>
        </route>
        
        <route id="CameraTrapProcessSubproject">
            <from uri="direct:processSubproject"/>
            <log message="${id} CameraTrapIngest: Started processing subproject ..."
                 loggingLevel="INFO"
                 logName="edu.si.ctingest"/>

            <!--
            <setHeader headerName="esc">
                <method ref="velocityToolsHandler" method="getVelocityEscapeTool"/>
            </setHeader>
            -->

            <!-- Look for the sub-project. -->
            <setBody>
                <xpath resultType="java.lang.String" headerName="ManifestXML">
                    //SubProjectName
                </xpath>
            </setBody>
            <setHeader headerName="CamelFedoraLabel">
                <simple>
                    ${body}
                </simple>
            </setHeader>
            <log message="${id} CameraTrapIngest: Sub-project: Label - ${body}  Parent PID - ${header.CamelFedoraPid}"
                 loggingLevel="DEBUG"
                 logName="edu.si.ctingest"/>
            <to uri="direct:findObject" />
            <choice>
                <when>
                    <simple>
                        ${body} == ''
                    </simple>
                    <log message="${id} CameraTrapIngest: Sub-project does not exist"
                         loggingLevel="DEBUG"
                         logName="edu.si.ctingest"/>
                    <!-- Stash the Project PID. -->
                    <setHeader headerName="ParentPID">
                        <simple>
                            ${header.CamelFedoraPid}
                        </simple>
                    </setHeader>
                    <!-- Create CT sub-project and add it as a sub-concept of the project. -->
                    <to uri="fedora:create?pid=null&amp;owner={{si.ct.owner}}&amp;namespace={{si.ct.namespace}}"/>
                    <!-- Add a minimal RELS-EXT to the sub-project -->
                    <to uri="velocity:file:Input/templates/CTPlotTemplate.vsl"/>
                    <to uri="fedora:addDatastream?name=RELS-EXT&amp;group=X&amp;dsLabel=RDF%20Statements%20about%20this%20object&amp;versionable=false"/>
                    <!-- Add Relation from parent CT project to the child CT sub-project -->
                    <to uri="fedora:hasConcept?parentPid=${header.ParentPID}&amp;childPid=${header.CamelFedoraPid}"/>
                    <to uri="velocity:file:Input/templates/CTPlotFGDC-ResearchTemplate.vsl"/>
                    <to uri="fedora:addDatastream?name=FGDC-Research&amp;type=text/xml&amp;group=X&amp;dsLabel=FGDC-Research%20Record&amp;versionable=true"/>
                </when>
                <otherwise>
                    <!-- Return the existing sub-project as the current object. -->
                    <log message="${id} CameraTrapIngest: Sub-project already exists - ${body}."
                         loggingLevel="DEBUG"
                         logName="edu.si.ctingest"/>
                    <setHeader headerName="CamelFedoraPid">
                        <simple>
                            ${body}
                        </simple>
                    </setHeader>
                </otherwise>
            </choice>

            <log message="${id} CameraTrapIngest: Finished processing subproject."
                 loggingLevel="INFO"
                 logName="edu.si.ctingest"/>
        </route>
        
        <route id="CameraTrapProcessProject">
            <from uri="direct:processProject"/>
            <log message="${id} CameraTrapIngest: Started processing project ..."
                 loggingLevel="INFO"
                 logName="edu.si.ctingest"/>

            <!--
            <setHeader headerName="esc">
                <method ref="velocityToolsHandler" method="getVelocityEscapeTool"/>
            </setHeader>
            -->

            <!-- Look for the project. -->
            <setBody>
                <xpath resultType="java.lang.String" headerName="ManifestXML">
                    //ProjectName
                </xpath>
            </setBody>
            <setHeader headerName="CamelFedoraLabel">
                <simple>
                    ${body}
                </simple>
            </setHeader>
            <log message="${id} CameraTrapIngest: Label - ${body}  Parent PID - ${header.CamelFedoraPid}."
                 loggingLevel="DEBUG"
                 logName="edu.si.ctingest"/>
            <to uri="direct:findObject"/>
            <choice>
                <when>
                    <simple>
                        ${body} == ''
                    </simple>
                    <log message="${id} CameraTrapIngest: Project does not exist."
                         loggingLevel="DEBUG"
                         logName="edu.si.ctingest"/>
                    <!-- Create CT project and add it as a sub-concept of the Camera Trap root object. -->
                    <to uri="fedora:create?pid=null&amp;owner={{si.ct.owner}}&amp;namespace={{si.ct.namespace}}"/>
                    <!-- Add a minimal RELS-EXT to the project. -->
                    <to uri="velocity:file:Input/templates/CTProjectTemplate.vsl"/>
                    <to uri="fedora:addDatastream?name=RELS-EXT&amp;group=X&amp;dsLabel=RDF%20Statements%20about%20this%20object&amp;versionable=false"/>
                    <!-- Add Relation from parent CT root object to the child CT project. -->
                    <to uri="fedora:hasConcept?parentPid={{si.ct.root}}&amp;childPid=${header.CamelFedoraPid}"/>
                    <to uri="velocity:file:Input/templates/CTProjectEAC-CPFTemplate.vsl"/>
                    <to uri="fedora:addDatastream?name=EAC-CPF&amp;type=text/xml&amp;group=X&amp;dsLabel=EAC-CPF&amp;versionable=true"/>
                </when>
                <otherwise>
                    <!-- Return the existing project as the current object. -->
                    <log message="${id} CameraTrapIngest: Project already exists - ${body}."
                         loggingLevel="DEBUG"
                         logName="edu.si.ctingest"/>
                    <setHeader headerName="CamelFedoraPid">
                        <simple>
                            ${body}
                        </simple>
                    </setHeader>
                </otherwise>
            </choice>

            <log message="${id} CameraTrapIngest: Finished processing project."
                 loggingLevel="INFO"
                 logName="edu.si.ctingest"/>
        </route>

    </camelContext>
</blueprint>