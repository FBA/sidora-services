<?xml version="1.0" encoding="UTF-8"?>

<blueprint xmlns="http://www.osgi.org/xmlns/blueprint/v1.0.0"
           xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
           xmlns:cm="http://aries.apache.org/blueprint/xmlns/blueprint-cm/v1.1.0"
           xsi:schemaLocation="http://www.osgi.org/xmlns/blueprint/v1.0.0 http://www.osgi.org/xmlns/blueprint/v1.0.0/blueprint.xsd">

    <!--  ActiveMQ destinations to use  -->
    <!--
    We likely want to change to a queue.
    <bean id="destination" class="org.apache.activemq.command.ActiveMQTopic">
        <constructor-arg type="java.lang.String" value="${sidora.broker.topics}"/>
    </bean>
    -->

    <!-- JMS ConnectionFactory to use, configuring the embedded broker using XML -->
    <bean id="connectionFactory" class="org.apache.activemq.spring.ActiveMQConnectionFactory">
        <!-- <property name="brokerURL" value="${broker.url}"/> -->
        <property name="brokerURL" value="tcp://localhost:61616"/>
    </bean>

    <!-- Use a pooled connections for scalability -->
    <bean id="pooledConnectionFactory" class="org.apache.activemq.pool.PooledConnectionFactory" init-method="start" destroy-method="stop">
        <property name="maxConnections" value="8" />
        <property name="connectionFactory" ref="connectionFactory" />
    </bean>

    <!-- Use pooled connections for JMS -->
    <bean id="jmsConfig" class="org.apache.camel.component.jms.JmsConfiguration">
        <property name="connectionFactory" ref="pooledConnectionFactory"/>
        <property name="concurrentConsumers" value="1"/>
        <!-- Until we choose our means of consuming this avoids duplication -->
        <!-- <property name="concurrentConsumers" value="10"/> -->
    </bean>

    <!-- Use the Camel JMS Components for performance and route flexibility -->
    <bean id="jms" class="org.apache.camel.component.jms.JmsComponent">
        <property name="connectionFactory" ref="connectionFactory"/>
    </bean>

    <!-- Use the Camel AMQ component for performance -->
    <bean id="activemq" class="org.apache.activemq.camel.component.ActiveMQComponent">
        <property name="configuration" ref="jmsConfig"/>
    </bean>

    <bean id="modelAggregator" class="edu.smithsonian.services.fedorarepo.aggregators.ContentModelAggregationStrategy"/>
    
    <bean id="contentModels" class="java.util.HashSet"/>

    <!-- Provides the Camel routing setup -->
    <camelContext id="DerivativesCamelContext"
                  xmlns="http://camel.apache.org/schema/blueprint"
                  xmlns:atom="http://www.w3.org/2005/Atom"
                  xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#"
                  xmlns:fs="info:fedora/fedora-system:def/model#"
                  xmlns:fedora-types="http://www.fedora.info/definitions/1/0/types/"
                  xmlns:fits="http://hul.harvard.edu/ois/xml/ns/fits/fits_output"
                  xmlns:fsmgmt="http://www.fedora.info/definitions/1/0/management/"
                  trace="true">
        
        <route id="DerivativesStartProcessing">
            <from uri="activemq:topic:fedora.apim.update"/>
            <log message="Starting Derivatives processing ..."/>
            <log message="PID: ${headers.pid} Method Name: ${headers.methodName}"/>
            <log message="Start of Derivatives Processing - ${body}"/>
            
            <!-- Get the login used by the source of the message, effectively this is the source of the message. -->
            <!-- Do not process messages coming from other Camel processes -->
            <log message="Fedora User - {{si.fedora.user}}"/>
            <filter>
                <xpath>/atom:entry/atom:author/atom:name = '{{si.fedora.user}}'</xpath>
                <stop/>
            </filter>
            
            <!-- If its a operation type of interest. -->
            <filter>
                <simple>
                    ${headers.methodName} in &#39;addDatastream,modifyDatastreamByValue,modifyDatastreamByReference,modifyObject,ingest&#39;
                </simple>
                <to uri="direct:processDerivativesMessage"/>
            </filter>
            
            <log message="Finished Derivatives processing!"/>
        </route>
        
        <route id="DerivativesProcessMessage">
            <from uri="direct:processDerivativesMessage"/>
            <log message="Starting Derivatives Message processing ..."/>
            
            <!-- Get the PID of the FDO that was just operated upon. -->
            <log message="PID: ${headers.pid} Method Name: ${headers.methodName}"/>
            <setHeader headerName="CamelFedoraPid"><simple>${headers.pid}</simple></setHeader>

            <!-- Get the DSID from the Atom message. -->
            <setHeader headerName="DSID">
                <xpath resultType="java.lang.String">/atom:entry/atom:category[@scheme="fedora-types:dsID"]/@term</xpath>
            </setHeader>
            <log message="DSID - ${headers.DSID}"/>

            <!-- Get the Content Models for the FDO and put them on a list. -->
            <to uri="fedora://getDatastreamDissemination?dsId=RELS-EXT&amp;exchangePattern=InOut"/>
            <convertBodyTo type="java.lang.String" charset="utf-8"/>
            <log message="Derivatives RELS-EXT: ${body}"/>
            <split strategyRef="modelAggregator">
                <xpath>//fs:hasModel/@rdf:resource</xpath>
                <log message="Split Content Model - ${body}"/>
            </split>
            <log message="Content Models - ${header.ContentModels}"/>
            
            <choice>
                <when> <!-- If imageCModel or generalImageCModel, and the DSID is "OBJ" process the image." -->
                    <spel>
                        #{(request.headers[ContentModels].contains('info:fedora/si:imageCModel') or
                          request.headers[ContentModels].contains('info:fedora/si:generalImageCModel')) and
                          request.headers[DSID] == 'OBJ'}
                    </spel>
                    <log message="Handle Image"/>
                    <to uri="direct:processDerivativesImage"/>
                </when>
                <when> <!-- If imageCModel or generalImageCModel, and the DSID is "OBJ" process the image." -->
                    <spel>
                        #{request.headers[ContentModels].contains('info:fedora/si:fieldbookCModel') and
                          request.headers[DSID] == 'OBJ'}
                    </spel>
                    <log message="Handle PDF"/>
                    <to uri="direct:processDerivativesPDF"/>
                </when>
                <when> <!-- If imageCModel or generalImageCModel, and the DSID is "OBJ" process the image." -->
                    <spel>
                        #{request.headers[ContentModels].contains('info:fedora/si:datasetCModel') and
                          request.headers[DSID] == 'OBJ'}
                    </spel>
                    <log message="Handle Dataset"/>
                    <to uri="direct:processDerivativesDataset"/>
                </when>
                <otherwise>
                    <log message="No derivatives message processing required"/>
                </otherwise>
            </choice>
            
            <log message="Finished Derivatives Message processing!"/>
        </route>

        <route id="DerivativesProcessImage">
            <from uri="direct:processDerivativesImage"/>
            <log message="Starting Derivatives Image processing ..."/>

            <!-- Submit the file to FITS processing. -->
            <!-- We really should only make new derivatives if the image has changed. -->
            <!-- We could get the MIME type from the datastream metadata or FITS (or both and compare). -->
            <!-- <to uri="direct://processDerivativesFITS"/> -->

            <!-- Get the MIME type from the datastream profile. -->
            <to uri="fedora://getDatastream?dsId=OBJ&amp;exchangePattern=InOut"/>
            <log message="Datastream Metadata - ${body}"/>
            <setHeader headerName="dsMIME">
                <xpath resultType="java.lang.String">/fsmgmt:datastreamProfile/fsmgmt:dsMIME/text()</xpath>
            </setHeader>
            <log message="Datastream Metadata Mime - ${header.dsMIME}"/>

            <!-- Get the Image and write it into a file in the staging area. -->
            <!-- Write the file as a stream to save memory. -->
            <to uri="fedora://getDatastreamDissemination?dsId=OBJ&amp;exchangePattern=InOut"/>
            <to uri="file://staging/"/>

            <!-- Determine what to do to make an image derivative as needed. -->
            <choice>
                <when> <!-- If the image is a JPEG? -->
                    <simple>
                        ${header.dsMIME} == 'image/jpg' || ${header.dsMIME} == 'image/jpeg'
                    </simple>
                    <log message="Handle JPEG"/>
                    <!-- Make a JPEG2000 archival image and store it in the MASTER datastream. Make a thumbnail. -->
                    <to uri="fedora://getDatastreamDissemination?dsId=OBJ&amp;exchangePattern=InOut"/>
                    <to uri="direct:derivativesCreateThumbnail"/>
                    <!-- Make a JPEG2000 archival image and store it in the MASTER datastream. -->
                    <!-- Delete the file from the staging area. -->
                </when>
                <when> <!-- If the image is a TIFF? -->
                    <simple>
                        ${header.dsMIME} == 'image/tiff' || ${header.dsMIME} == 'image/tif'
                    </simple>
                    <log message="Handle Tiff"/>
                    <!-- Make a JPEG and store it as a new version in the OBJ datastream. -->
                    <!-- Make a JPEG2000 archival image and store it in the IMAGE datastream. -->
                    <to uri="fedora://getDatastreamDissemination?dsId=OBJ&amp;exchangePattern=InOut"/>
                    <to uri="direct:derivativesCreateThumbnail"/>
                </when>
                <when> <!-- If the image is a JPEG2000? -->
                    <simple>
                        ${header.dsMIME} == 'image/jp2'
                    </simple>
                    <log message="Handle JPEG2000"/>
                    <!-- Convert the image to JPEG and store that in the DISPLAY datastream. Make a thumbnail. -->
                    <to uri="fedora://getDatastreamDissemination?dsId=OBJ&amp;exchangePattern=InOut"/>
                    <recipientList>
                        <simple>
                            exec:convert?args=${header.CamelFileNameProduced}%20${header.CamelFileNameProduced}.jpg
                        </simple>
                    </recipientList>
                    <setBody><simple>${header.CamelFileNameProduced}.jpg</simple></setBody>
                    <to uri="reader:file"/>
                    <to uri="fedora:addDatastream?name=DISPLAY&amp;type=image/jpg&amp;group=M"/>
                    <to uri="direct:derivativesCreateThumbnail"/>
                    <!-- Delete the file from the staging area. -->
                </when>
                <otherwise>
                    <!-- If the image is some other mime type just store it in the IMAGE datastream? -->
                    <log message="Unsupported image type found - ${headers.dsMIME}"/>
                </otherwise>
            </choice>

            <!-- Delete the file from the staging area. -->
            <!-- Camel generates a unique name for the file but we need to clean it out of staging after things are done. -->
            
            <log message="Finished Derivatives Image processing!"/>
        </route>

        <route id="DerivativesProcessDataset">
            <from uri="direct:processDerivativesDataset"/>
            <log message="Starting Derivatives Dataset processing ..."/>

            <!-- Submit the file to FITS processing. -->
            <!-- We really should only make new derivatives if the image has changed. -->
            <!-- Camel generates a unique name for the file but we need to clean it out of staging after things are done. -->
            <!-- We could get the MIME type from the datastream metadata or FIT (or both and compare). -->
            <!-- <to uri="direct://processDerivativesFITS"/> -->

            <!-- Get the MIME type from the datastream profile. -->
            <to uri="fedora://getDatastream?dsId=OBJ&amp;exchangePattern=InOut"/>
            <log message="Datastream Metadata - ${body}"/>
            <setHeader headerName="dsMIME">
                <xpath resultType="java.lang.String">/fsmgmt:datastreamProfile/fsmgmt:dsMIME/text()</xpath>
            </setHeader>
            <log message="Datastream Metadata Mime - ${header.dsMIME}"/>
            
            <!-- Create a CSV datastream. -->
            <choice>
                <when> <!-- If the content is Excel? -->
                    <simple>
                        ${header.dsMIME} == 'application/vnd.ms-excel'
                    </simple>
                    <log message="Handle Excel"/>

                    <!-- Get the PDF and write it into a file in the staging area. -->
                    <!-- Write the file as a stream to save memory. -->
                    <to uri="fedora://getDatastreamDissemination?dsId=OBJ&amp;exchangePattern=InOut"/>
                    <to uri="file://staging/"/>

                    <!-- Convert to CSV -->
                    <!-- Add a CSV datastream to the object. -->
                </when>
                <when> <!-- If the content is a CSV? -->
                    <simple>
                        ${header.dsMIME} == 'text/csv'
                    </simple>
                    <log message="Handle CSV"/>

                    <!-- Get the PDF and write it into a file in the staging area. -->
                    <!-- Write the file as a stream to save memory. -->
                    <to uri="fedora://getDatastreamDissemination?dsId=OBJ&amp;exchangePattern=InOut"/>
                    <to uri="file://staging/"/>

                    <!-- Add a CSV datastream to the object. -->
                </when>
                <otherwise>
                    <!-- If the image is some other mime type just store it in the IMAGE datastream? -->
                    <log message="Not a PDF - ${headers.dsMIME}"/>
                </otherwise>
            </choice>

            <!-- Delete the file from the staging area. -->

            <log message="Finished Derivatives Dataset processing!"/>
        </route>

        <route id="DerivativesProcessPDF">
            <from uri="direct:processDerivativesPDF"/>
            <log message="Starting Derivatives PDF processing ..."/>

            <!-- Submit the file to FITS processing. -->
            <!-- We really should only make new derivatives if the image has changed. -->
            <!-- Camel generates a unique name for the file but we need to clean it out of staging after things are done. -->
            <!-- We could get the MIME type from the datastream metadata or FIT (or both and compare). -->
            <!-- <to uri="direct://processDerivativesFITS"/> -->

            <!-- Get the MIME type from the datastream profile. -->
            <to uri="fedora://getDatastream?dsId=OBJ&amp;exchangePattern=InOut"/>
            <log message="Datastream Metadata - ${body}"/>
            <setHeader headerName="dsMIME">
                <xpath resultType="java.lang.String">/fsmgmt:datastreamProfile/fsmgmt:dsMIME/text()</xpath>
            </setHeader>
            <log message="Datastream Metadata Mime - ${header.dsMIME}"/>
            
            <!-- Only convert PDF datastreams. -->
            <choice>
                <when> <!-- If the content is a PDF? -->
                    <simple>
                        ${header.dsMIME} == 'application/pdf'
                    </simple>
                    <log message="Handle PDF"/>
                    
                    <!-- Get the PDF and write it into a file in the staging area. -->
                    <!-- Write the file as a stream to save memory. -->
                    <to uri="fedora://getDatastreamDissemination?dsId=OBJ&amp;exchangePattern=InOut"/>
                    <to uri="file://staging/"/>

                    <!-- Create a thumbnail. -->
                    <recipientList>
                        <simple>
                            exec:convert?args=${header.CamelFileNameProduced}%20${header.CamelFileNameProduced}.jpg
                        </simple>
                    </recipientList>
                    <setBody><simple>${header.CamelFileNameProduced}-0.jpg</simple></setBody>
                    <to uri="reader:file"/>
                    <to uri="direct:derivativesCreateThumbnail"/>

                    <!-- Create a Flash derivative to use with the Flexpaper viewer. -->
                    <recipientList>
                        <simple>
                            exec:pdf2swf?args=${header.CamelFileNameProduced}%20-o%20${header.CamelFileNameProduced}.swf
                        </simple>
                    </recipientList>
                    <!--
                    <setBody><simple>${header.CamelFileNameProduced}.swf</simple></setBody>
                    <to uri="reader:file"/>
                    <to uri="fedora:addDatastream?name=OBJ.swf&amp;type=image/jpg&amp;group=M"/>
                    -->
                </when>
                <otherwise>
                    <!-- If the image is some other mime type just store it in the IMAGE datastream? -->
                    <log message="Not a PDF - ${headers.dsMIME}"/>
                </otherwise>
            </choice>

            <!-- Delete the file from the staging area. -->

            <log message="Finished Derivatives PDF processing!"/>
        </route>

        <route id="DerivativesProcessFITS">
            <from uri="direct:processDerivativesFITS"/>
            <log message="Started Derivatives FITS processing ..."/>
            <!-- TODO: Check if the call was successful and notify if not. -->
            <recipientList><simple>exec:fits?args=-i ${header.CamelFileNameProduced}</simple></recipientList>
            <!-- Unless CamelExecExitValue=0 its an error. -->
            <!-- Get the mime-type from the FITS output. -->
            <!-- This can get complicated so we take the simple approach first. -->
            <setHeader headerName="dsMIME">
                <xpath resultType="java.lang.String">/fits:fits/fits:identification/fits:identity[1]/@mimetype</xpath>
            </setHeader>
            <log message="FITS mimetype - ${headers.FITSmimeType}"/>
            <log message="Exec FITS - ${body}"/>
            <to uri="fedora:addDatastream?name=FITS&amp;type=text/xml&amp;group=X"/>
            <log message="Finished Derivatives FITS processing."/>
        </route>

        <route id="DerivativesCreateThumbnailImage">
            <from uri="direct:derivativesCreateThumbnail"/>
            <log message="Started Derivatives Creating Thumbnail processing ..."/>
            <to uri="thumbnailator:image?keepRatio=false&amp;size=(200,150)"/>
            <to uri="fedora:addDatastream?name=TN&amp;type=image/jpeg&amp;group=M"/>
            <log message="Finished Derivatives Create Thumbnail processing."/>
        </route>

    </camelContext>
    
</blueprint>
