<?xml version="1.0" encoding="UTF-8"?>

<blueprint xmlns="http://www.osgi.org/xmlns/blueprint/v1.0.0"
           xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
           xmlns:cm="http://aries.apache.org/blueprint/xmlns/blueprint-cm/v1.1.0"
           xsi:schemaLocation="http://www.osgi.org/xmlns/blueprint/v1.0.0 http://www.osgi.org/xmlns/blueprint/v1.0.0/blueprint.xsd">

    <!-- <osgi:reference id="activemq" interface="org.apache.camel.Component"/> -->

    <!--  ActiveMQ destinations to use  -->
    <!--
    We likely want to change to a queue.
    <bean id="destination" class="org.apache.activemq.command.ActiveMQTopic">
        <constructor-arg type="java.lang.String" value="${sidora.broker.topics}"/>
    </bean>
    -->

    <!-- JMS ConnectionFactory to use, configuring the embedded broker using XML -->
    <bean id="connectionFactory" class="org.apache.activemq.spring.ActiveMQConnectionFactory">
        <!-- <property name="brokerURL" value="${broker.url}"/> -->
        <property name="brokerURL" value="tcp://localhost:61616"/>
        <property name="userName" value="smx"/>
        <property name="password" value="smx"/>
    </bean>

    <!-- Use a pooled connections for scalability -->
    <bean id="pooledConnectionFactory" class="org.apache.activemq.pool.PooledConnectionFactory" init-method="start" destroy-method="stop">
        <property name="maxConnections" value="8" />
        <property name="connectionFactory" ref="connectionFactory" />
    </bean>

    <!-- Use pooled connections for JMS -->
    <bean id="jmsConfig" class="org.apache.camel.component.jms.JmsConfiguration">
        <property name="connectionFactory" ref="pooledConnectionFactory"/>
        <property name="concurrentConsumers" value="1"/>
        <!-- When ready we can make this run more consumers. -->
        <!-- <property name="concurrentConsumers" value="10"/> -->
    </bean>

    <!-- Use the Camel JMS Components for performance and route flexibility -->
    <bean id="jms" class="org.apache.camel.component.jms.JmsComponent">
        <property name="connectionFactory" ref="connectionFactory"/>
    </bean>

    <!-- Use the Camel AMQ component for performance -->
    <bean id="activemq" class="org.apache.activemq.camel.component.ActiveMQComponent">
        <property name="configuration" ref="jmsConfig"/>
    </bean>

    <bean id="excelToCSV" class="edu.si.services.beans.excel.ExcelToCSV"/>

    <bean id="modelAggregator" class="edu.si.services.fedorarepo.aggregators.ContentModelAggregationStrategy"/>
    
    <bean id="contentModels" class="java.util.HashSet"/>

    <!-- Provides the Camel routing setup -->
    <camelContext id="DerivativesCamelContext"
                  xmlns="http://camel.apache.org/schema/blueprint"
                  xmlns:atom="http://www.w3.org/2005/Atom"
                  xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#"
                  xmlns:fs="info:fedora/fedora-system:def/model#"
                  xmlns:fedora-types="http://www.fedora.info/definitions/1/0/types/"
                  xmlns:fits="http://hul.harvard.edu/ois/xml/ns/fits/fits_output"
                  xmlns:fsmgmt="http://www.fedora.info/definitions/1/0/management/"
                  trace="false"
                  streamCache="true">

        <!--
            The "unused" namespace definitions above are needed to deal with the way Camel handles namespaces in XPath.
        -->

        <errorHandler id="derivativesErrorHandler" type="DefaultErrorHandler">
            <redeliveryPolicy maximumRedeliveries="20"
                              retryAttemptedLogLevel="WARN"
                              backOffMultiplier="2"
                              useExponentialBackOff="true"/>
        </errorHandler>

        <route id="DerivativesStartProcessing">
            <from uri="activemq:queue:sidora.apim.update"/>
            <log message="${id} Derivatives: Starting processing ..."
                 loggingLevel="DEBUG"
                 logName="edu.si.derivatives"/>
            <log message="${id} Derivatives: Processing PID: ${headers.pid}  Method Name: ${headers.methodName}  Origin: {{si.fedora.user}}"/>
            <log message="${id} Derivatives: Processing BODY: ${body}"
                 loggingLevel="DEBUG"
                 logName="edu.si.derivatives"/>
            
            <!--
                The login used by the source of the message is put in the ATOM Author element by Fedora. Since this
                is a system login not a end-user, we can use this to identify the process that is the source of
                the message.
            -->

            <!-- Filter for messages coming from monitored processes. -->
            <filter>
                <xpath>
                    /atom:entry/atom:author/atom:name = '{{si.fedora.user}}'
                </xpath>
                <log message="${id} Derivatives: No message processing required."/>
                <stop/>
            </filter>
            
            <!-- Filter out Fedora API methods that do not need derivatives processing. -->
            <!-- This could be done with a JMS selector. -->
            <filter>
                <simple>
                    ${headers.methodName} in &#39;addDatastream,modifyDatastreamByValue,modifyDatastreamByReference,modifyObject,ingest&#39;
                </simple>
                <log message="${id} Derivatives: Process Message."/>
                <to uri="direct:processDerivativesMessage"/>
            </filter>
            
            <log message="${id} Derivatives: Finished processing."/>
        </route>
        
        <route id="DerivativesProcessMessage">
            <from uri="direct:processDerivativesMessage"/>
            <log message="${id} Derivatives: Starting Derivatives Message processing ..."
                 loggingLevel="DEBUG"
                 logName="edu.si.derivatives"/>
            
            <!-- Get the PID of the FDO that was just operated upon. -->
            <log message="${id} Derivatives: PID: ${headers.pid}  Method Name: ${headers.methodName}"
                 loggingLevel="DEBUG"
                 logName="edu.si.derivatives"/>
            <setHeader headerName="CamelFedoraPid">
                <simple>
                    ${headers.pid}
                </simple>
            </setHeader>

            <!-- Get the DSID from the Atom message if any. -->
            <setHeader headerName="DSID">
                <xpath resultType="java.lang.String">
                    /atom:entry/atom:category[@scheme="fedora-types:dsID"]/@term
                </xpath>
            </setHeader>
            <log message="${id} Derivatives: Atom DSID: ${headers.DSID}"
                 loggingLevel="DEBUG"
                 logName="edu.si.derivatives"/>

            <!-- Get the Content Models for the FDO and put them on a list. -->
            <to uri="fedora://getDatastreamDissemination?dsId=RELS-EXT&amp;exchangePattern=InOut"/>
            <convertBodyTo type="java.lang.String" charset="utf-8"/>
            <log message="${id} Derivatives: RELS-EXT: ${body}"
                 loggingLevel="DEBUG"
                 logName="edu.si.derivatives"/>
            <split strategyRef="modelAggregator">
                <xpath>
                    //fs:hasModel/@rdf:resource
                </xpath>
                <log message="${id} Derivatives: Split Content Model. BODY: ${body}"
                     loggingLevel="DEBUG"
                     logName="edu.si.derivatives"/>
            </split>
            <log message="${id} Derivatives: Content Models: ${header.ContentModels}"
                 loggingLevel="DEBUG"
                 logName="edu.si.derivatives"/>
            
            <choice> <!-- Filter by content model. -->
                <when> <!-- If imageCModel or generalImageCModel, and the DSID is "OBJ" - process the image." -->
                    <spel>
                        #{(request.headers[ContentModels].contains('info:fedora/si:imageCModel') or
                          request.headers[ContentModels].contains('info:fedora/si:generalImageCModel')) and
                          request.headers[DSID] == 'OBJ'}
                    </spel>
                    <log message="${id} Derivatives: Found Image."
                         loggingLevel="DEBUG"
                         logName="edu.si.derivatives"/>
                    <to uri="direct:processDerivativesImage"/>
                </when>
                <when> <!-- If imageCModel or generalImageCModel, and the DSID is "OBJ" - process the image." -->
                    <spel>
                        #{request.headers[ContentModels].contains('info:fedora/si:fieldbookCModel') and
                          request.headers[DSID] == 'OBJ'}
                    </spel>
                    <log message="${id} Derivatives: Found PDF."
                         loggingLevel="DEBUG"
                         logName="edu.si.derivatives"/>
                    <to uri="direct:processDerivativesPDF"/>
                </when>
                <when> <!-- If imageCModel or generalImageCModel, and the DSID is "OBJ" - process the image." -->
                    <spel>
                        #{request.headers[ContentModels].contains('info:fedora/si:datasetCModel') and
                          request.headers[DSID] == 'OBJ'}
                    </spel>
                    <log message="${id} Derivatives: Found Dataset."
                         loggingLevel="DEBUG"
                         logName="edu.si.derivatives"/>
                    <to uri="direct:processDerivativesDataset"/>
                </when>
                <otherwise> <!-- No supported content model was found. -->
                    <log message="${id} Derivatives: No message processing required."/>
                </otherwise>
            </choice>
            
            <log message="${id} Derivatives: Finished Message processing."
                 loggingLevel="DEBUG"
                 logName="edu.si.derivatives"/>
        </route>

        <route id="DerivativesProcessImage">
            <from uri="direct:processDerivativesImage"/>
            <log message="${id} Derivatives: Starting Image processing ..."
                 loggingLevel="DEBUG"
                 logName="edu.si.derivatives"/>

            <!-- We could submit the file to FITS processing to get the MIME but that can be complicated. -->
            <!-- We could get the MIME type from the datastream metadata or FITS (or both and compare). -->
            <!-- For now we will just trust Fedora's datastream metadata. -->
            <!-- We really should only make new derivatives if the OBJ has changed. -->

            <!-- Get the MIME type from the datastream profile. -->
            <to uri="fedora://getDatastream?dsId=OBJ&amp;exchangePattern=InOut"/>
            <log message="${id} Derivatives: Datastream Metadata. BODY: ${body}"
                 loggingLevel="DEBUG"
                 logName="edu.si.derivatives"/>
            <setHeader headerName="dsMIME">
                <xpath resultType="java.lang.String">
                    /fsmgmt:datastreamProfile/fsmgmt:dsMIME/text()
                </xpath>
            </setHeader>
            <log message="${id} Derivatives: Datastream Metadata. MIME: ${header.dsMIME}"
                 loggingLevel="DEBUG"
                 logName="edu.si.derivatives"/>

            <!--
                DGI has quite a bit more in their Python conversions so we need to improve this.
            -->

            <to uri="fedora://getDatastreamDissemination?dsId=OBJ&amp;exchangePattern=InOut"/>
            <to uri="file://staging/"/>
            <log message="${id} Derivatives: Staged file. BODY: ${body}"
                 loggingLevel="DEBUG"
                 logName="edu.si.derivatives"/>

            <choice> <!-- Filter content by image format. -->

                <when> <!-- If the image is a JPEG? Add an archival JPEG2000 and a thumbnail to the FDO. -->
                    <simple>
                        ${header.dsMIME} == 'image/jpg' || ${header.dsMIME} == 'image/jpeg' || ${header.dsMIME} == 'image/jpe'
                    </simple>
                    <log message="${id} Derivatives: Found JPEG."
                         loggingLevel="DEBUG"
                         logName="edu.si.derivatives"/>
                    <!-- Add a thumbnail from the JPEG. -->
                    <multicast>
                        <to uri="direct://processDerivativesThumbnailator"/>
                        <to uri="direct://processDerivativesFITS"/>
                        <!-- Future: Make a JPEG2000 archival image and store it in the MASTER datastream. -->
                    </multicast>
                </when>

                <when> <!-- If the image is a TIFF? Add a JPG datastream and thumbnail for the image to the FDO. -->
                    <simple>
                        ${header.dsMIME} == 'image/tiff' || ${header.dsMIME} == 'image/tif'
                    </simple>
                    <log message="${id} Derivatives: Found TIFF."
                         loggingLevel="DEBUG"
                         logName="edu.si.derivatives"/>
                    <multicast>
                        <to uri="direct://processDerivativesTIFFImage"/>
                        <to uri="direct://processDerivativesFITS"/>
                        <!-- Future: Make a JPEG2000 archival image and store it in the MASTER datastream. -->
                    </multicast>
                </when>

                <when> <!-- If the image is a JPEG2000? Add a JPG datastream and thumbnail to the FDO. -->
                    <simple>
                        ${header.dsMIME} == 'image/jp2'
                    </simple>
                    <log message="${id} Derivatives: Found JPEG2000."
                         loggingLevel="DEBUG"
                         logName="edu.si.derivatives"/>
                    <multicast>
                        <to uri="direct://processDerivativesJP2Image"/>
                        <to uri="direct://processDerivativesFITS"/>
                    </multicast>
                </when>

                <when> <!-- If the image is a PNG, GIF, BMP? Add a JPG datastream and thumbnail for the image to the FDO. -->
                    <simple>
                        ${header.dsMIME} == 'image/png' || ${header.dsMIME} == 'image/gif' || ${header.dsMIME} == 'image/bmp'
                    </simple>
                    <log message="${id} Derivatives: Found PNG, GIF or BMP."
                         loggingLevel="DEBUG"
                         logName="edu.si.derivatives"/>
                    <multicast>
                        <to uri="direct://processDerivativesBGPImage"/>
                        <to uri="direct://processDerivativesFITS"/>
                        <!-- Future: Make a JPEG2000 archival image and store it in the MASTER datastream. -->
                    </multicast>
                </when>

                <otherwise>
                    <!-- If the image is some other MIME type, just log a warning? -->
                    <log message="${id} Derivatives: Unsupported image type found. MIME: ${headers.dsMIME}"
                         loggingLevel="WARN"/>
                </otherwise>

            </choice>

            <recipientList> <!-- Delete the temporary file. Note: This approach is Unix specific. -->
                <simple>
                    exec:rm?args=-f ${header.CamelFileNameProduced}
                </simple>
            </recipientList>
            <choice>
                <when>
                    <simple>
                        ${headers.CamelExecExitValue} != 0
                    </simple>
                    <log message="${id} Derivatives: Unable to delete working file. Filename: ${headers.CamelFileNameProduced}"
                         loggingLevel="WARN"/>
                    <!-- We also want to proactively tell monitoring -->
                </when>
            </choice>

            <log message="${id} Derivatives: Finished Image processing."
                 loggingLevel="DEBUG"
                 logName="edu.si.derivatives"/>
        </route>

        <route id="DerivativesProcessTIFFImage">
            <from uri="direct:processDerivativesTIFFImage"/>
            <log message="${id} Derivatives: Starting TIFF image processing ..."
                 loggingLevel="DEBUG"
                 logName="edu.si.derivatives"/>

            <recipientList>
                <simple>
                    <!-- exec:convert?args= - jpg:- -->
                    exec:convert?args= - jpg:${header.CamelFileNameProduced}.jpg
                </simple>
            </recipientList>
            <choice>
                <when> <!-- If the conversion succeeded? Add a display datastream for the image to the FDO. -->
                    <simple>
                        ${headers.CamelExecExitValue} == 0
                    </simple>
                    <setBody>
                        <simple>
                            ${header.CamelFileNameProduced}.jpg
                        </simple>
                    </setBody>
                    <to uri="reader:file"/>
                    <to uri="fedora:addDatastream?name=DISPLAY&amp;type=image/jpg&amp;group=M&amp;dsLabel=DISPLAY&amp;versionable=false"/>
                    <!-- Also add a thumbnail from the JPEG since TIFF is not supported. -->
                    <to uri="direct:processDerivativesThumbnailator"/>

                    <!-- Delete the temporary JPG conversion file. Note: This approach is Unix specific. -->
                    <recipientList>
                        <simple>
                            exec:rm?args=-f ${header.CamelFileNameProduced}.jpg
                        </simple>
                    </recipientList>
                    <choice>
                        <when>
                            <simple>
                                ${headers.CamelExecExitValue} != 0
                            </simple>
                            <log message="${id} Derivatives: Unable to delete working file. Filename: ${headers.CamelFileNameProduced}.jpg"
                                 loggingLevel="WARN"/>
                            <!-- We also want to proactively tell monitoring -->
                        </when>
                    </choice>
                </when>
                <otherwise>
                    <log message="${id} Derivatives: Unable to convert TIFF to JPG. PID: ${headers.CamelFedoraPid}  Error Code: ${headers.CamelExecExitValue}"
                         loggingLevel="ERROR"/>
                </otherwise>
            </choice>

            <log message="${id} Derivatives: Finished TIFF Image processing."
                 loggingLevel="DEBUG"
                 logName="edu.si.derivatives"/>
        </route>

        <route id="DerivativesProcessJP2Image">
            <from uri="direct:processDerivativesJP2Image"/>
            <log message="${id} Derivatives: Starting JP2 image processing ..."
                 loggingLevel="DEBUG"
                 logName="edu.si.derivatives"/>

            <!-- We need to convert to a good lossless JPEG2000. This current code uses a very naive approach. -->

            <recipientList>
                <simple>
                    <!-- exec:convert?args= - jpg:- -->
                    exec:convert?args= - jpg:${header.CamelFileNameProduced}.jpg
                </simple>
            </recipientList>
            <choice>
                <when> <!-- If the conversion succeeded, Add a display datastream for the image to the FDO? -->
                    <simple>
                        ${headers.CamelExecExitValue} == 0
                    </simple>
                    <setBody>
                        <simple>
                            ${header.CamelFileNameProduced}.jpg
                        </simple>
                    </setBody>
                    <to uri="reader:file"/>
                    <to uri="fedora:addDatastream?name=DISPLAY&amp;type=image/jpg&amp;group=M&amp;dsLabel=DISPLAY&amp;versionable=false"/>
                    <!-- Also add a thumbnail from the JPEG since JPG2 is not supported. -->
                    <to uri="direct:processDerivativesThumbnailator"/>

                    <!-- Delete the temporary JPG conversion file. Note: This approach is Unix specific. -->
                    <recipientList>
                        <simple>
                            exec:rm?args=-f ${header.CamelFileNameProduced}.jpg
                        </simple>
                    </recipientList>
                    <choice>
                        <when>
                            <simple>
                                ${headers.CamelExecExitValue} != 0
                            </simple>
                            <log message="${id} Derivatives: Unable to delete working file. Filename: ${headers.CamelFileNameProduced}.jpg"
                                 loggingLevel="WARN"/>
                            <!-- We also want to proactively tell monitoring -->
                        </when>
                    </choice>
                </when>
                <otherwise>
                    <log message="${id} Derivatives: Unable to convert JP2 to JPG. PID: ${headers.CamelFedoraPid}  Error Code: ${headers.CamelExecExitValue}"
                         loggingLevel="ERROR"/>
                </otherwise>
            </choice>

            <log message="${id} Derivatives: Finished JP2 Image processing."
                 loggingLevel="DEBUG"
                 logName="edu.si.derivatives"/>
        </route>

        <route id="DerivativesProcessBGPImage">
            <from uri="direct:processDerivativesBGPImage"/>
            <log message="${id} Derivatives: Starting BGP image processing ..."
                 loggingLevel="DEBUG"
                 logName="edu.si.derivatives"/>

            <recipientList>
                <simple>
                    <!-- exec:convert?args= - jpg:- -->
                    exec:convert?args= - jpg:${header.CamelFileNameProduced}.jpg
                </simple>
            </recipientList>
            <choice>
                <when> <!-- If the conversion succeeded? Add a display datastream for the image to the FDO. -->
                    <simple>
                        ${headers.CamelExecExitValue} == 0
                    </simple>
                    <setBody>
                        <simple>
                            ${header.CamelFileNameProduced}.jpg
                        </simple>
                    </setBody>
                    <to uri="reader:file"/>
                    <to uri="fedora:addDatastream?name=DISPLAY&amp;type=image/jpg&amp;group=M&amp;dsLabel=DISPLAY&amp;versionable=false"/>
                    <to uri="direct://processDerivativesThumbnailator"/>

                    <!-- Delete the temporary JPG conversion file. Note: This approach is Unix specific. -->
                    <recipientList>
                        <simple>
                            exec:rm?args=-f ${header.CamelFileNameProduced}.jpg
                        </simple>
                    </recipientList>
                    <choice>
                        <when>
                            <simple>
                                ${headers.CamelExecExitValue} != 0
                            </simple>
                            <log message="${id} Derivatives: Unable to delete working file. Filename: ${headers.CamelFileNameProduced}.jpg"
                                 loggingLevel="WARN"/>
                            <!-- We also want to proactively tell monitoring -->
                        </when>
                    </choice>
                </when>
                <otherwise>
                    <log message="${id} Derivatives: Unable to convert TIFF to JPG. PID: ${headers.CamelFedoraPid}  Error Code: ${headers.CamelExecExitValue}"
                         loggingLevel="ERROR"/>
                </otherwise>
            </choice>

            <log message="${id} Derivatives: Finished BGP Image processing."
                 loggingLevel="DEBUG"
                 logName="edu.si.derivatives"/>
        </route>

        <route id="DerivativesProcessDataset">
            <from uri="direct:processDerivativesDataset"/>
            <log message="${id} Derivatives: Starting Dataset processing ..."
                 loggingLevel="DEBUG"
                 logName="edu.si.derivatives"/>

            <!-- We could submit the file to FITS processing to get the MIME but that can be complicated. -->
            <!-- We could get the MIME type from the datastream metadata or FITS (or both and compare). -->
            <!-- For now we will just trust Fedora's datastream metadata. -->
            <!-- We really should only make new derivatives if the OBJ has changed. -->
            <!-- <to uri="direct://processDerivativesFITS"/> -->

            <!-- Get the MIME type from the datastream profile. -->
            <to uri="fedora://getDatastream?dsId=OBJ&amp;exchangePattern=InOut"/>
            <log message="${id} Derivatives: Datastream Metadata. BODY: ${body}"
                 loggingLevel="DEBUG"
                 logName="edu.si.derivatives"/>

            <setHeader headerName="dsMIME">
                <xpath resultType="java.lang.String">
                    /fsmgmt:datastreamProfile/fsmgmt:dsMIME/text()
                </xpath>
            </setHeader>
            <log message="${id} Derivatives: Datastream Metadata. MIME: ${header.dsMIME}"
                 loggingLevel="DEBUG"
                 logName="edu.si.derivatives"/>

            <choice> <!-- Filter content by dataset format. -->

                <when> <!-- If the content is Excel? -->
                    <simple>
                        ${header.dsMIME} == 'application/vnd.ms-excel' || ${header.dsMIME} == 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
                    </simple>
                    <log message="${id} Derivatives: Found Excel."
                         loggingLevel="DEBUG"
                         logName="edu.si.derivatives"/>
                    <to uri="fedora://getDatastreamDissemination?dsId=OBJ&amp;exchangePattern=InOut"/>
                    <bean ref="excelToCSV" method="convertExcelToCSV"/>
                    <to uri="fedora:addDatastream?name=CSV&amp;type=text/csv&amp;group=M&amp;dsLabel=CSV&amp;versionable=false"/>
                </when>

                <when> <!-- If the content is a CSV? Just add a datastream to the FDO. -->
                    <simple>
                        ${header.dsMIME} == 'text/csv'
                    </simple>
                    <log message="${id} Derivatives: Found CSV."
                         loggingLevel="DEBUG"
                         logName="edu.si.derivatives"/>

                    <!-- Copy the OBJ datastream to the CSV datastream. -->
                    <to uri="fedora://getDatastreamDissemination?dsId=OBJ&amp;exchangePattern=InOut"/>
                    <to uri="fedora:addDatastream?name=CSV&amp;type=text/csv&amp;group=M&amp;dsLabel=CSV&amp;versionable=false"/>
                </when>

                <otherwise>
                    <!-- If the dataset is some other mime type, just log a warning? -->
                    <log message="${id} Derivatives: Not a supported dataset format.. MIME: ${headers.dsMIME}"
                         loggingLevel="WARN"/>
                </otherwise>

            </choice>

            <log message="${id} Derivatives: Finished Dataset processing."
                 loggingLevel="DEBUG"
                 logName="edu.si.derivatives"/>
        </route>

        <route id="DerivativesProcessPDF">
            <from uri="direct:processDerivativesPDF"/>
            <log message="${id} Derivatives: Starting PDF processing ..."
                 loggingLevel="DEBUG"
                 logName="edu.si.derivatives"/>

            <!-- We really should make new derivatives only if OBJ has changed. -->
            <!-- We could get the MIME type from the datastream metadata or FITS (or both and compare). -->
            <!-- <to uri="direct://processDerivativesFITS"/> -->

            <!-- Get the MIME type from the datastream profile. -->
            <!-- We should try the getDatastream more than once if it fails. -->
            <to uri="fedora://getDatastream?dsId=OBJ&amp;exchangePattern=InOut"/>
            <log message="${id} Derivatives: Datastream Metadata. BODY: ${body}"
                 loggingLevel="DEBUG"
                 logName="edu.si.derivatives"/>

            <setHeader headerName="dsMIME">
                <xpath resultType="java.lang.String">
                    /fsmgmt:datastreamProfile/fsmgmt:dsMIME/text()
                </xpath>
            </setHeader>
            <log message="${id} Derivatives: Datastream Metadata. MIME: ${header.dsMIME}"
                 loggingLevel="DEBUG"
                 logName="edu.si.derivatives"/>

            <choice> <!-- Filter the content by PDF type (remember PDF-A) -->

                <when> <!-- If the content is a PDF? Create a thumbnail and an SWF derivative. -->
                    <simple>
                        ${header.dsMIME} == 'application/pdf'
                    </simple>
                    <log message="${id} Derivatives: Process PDF."
                         loggingLevel="DEBUG"
                         logName="edu.si.derivatives"/>
                    
                    <!-- Get the PDF from the FDO. -->
                    <!-- We should try the getDatastreamDissemination more than once if it fails. -->
                    <to uri="fedora://getDatastreamDissemination?dsId=OBJ&amp;exchangePattern=InOut"/>
                    <to uri="file://staging/"/>  <!-- This will create a temporary file that must be cleaned out. -->

                    <to uri="direct:processDerivativesThumbnailImage"/>
                    <to uri="direct:processDerivativesPDF2SWF"/>

                    <recipientList> <!-- Delete the temporary file. Note: This approach is Unix specific. -->
                        <simple>
                            exec:rm?args=-f ${header.CamelFileNameProduced}
                        </simple>
                    </recipientList>
                    <choice>
                        <when>
                            <simple>
                              ${headers.CamelExecExitValue} != 0
                            </simple>
                            <log message="${id} Derivatives: Unable to delete working file. Filename: ${headers.CamelFileNameProduced}"
                                 loggingLevel="WARN"/>
                            <!-- We also want to proactively tell monitoring -->
                       </when>
                    </choice>
                </when>
                <otherwise>
                    <!-- If the PDF is some other mime type, just log a warning? -->
                    <log message="${id} Derivatives: Not a PDF. MIME: ${headers.dsMIME}"
                         loggingLevel="WARN"
                         logName="edu.si.derivatives"/>
                </otherwise>
            </choice>

            <log message="${id} Derivatives: Finished PDF processing."
                 loggingLevel="DEBUG"
                 logName="edu.si.derivatives"/>
        </route>

        <route id="DerivativesProcessPDF2SWF">
            <from uri="direct:processDerivativesPDF2SWF"/>
            <log message="${id} Derivatives: Started PDF2SWF processing ..."
                 loggingLevel="DEBUG"
                 logName="edu.si.derivatives"/>

            <!-- Create a Flash derivative using pdf2swf for the Flexpaper viewer. -->
            <!-- Unfortunately pdf2swf cannot accept a pipe as an input stream source, hence we use a temporary file. -->

            <recipientList>
                <simple>
                    exec:pdf2swf?args=${header.CamelFileNameProduced} -o ${header.CamelFileNameProduced}.swf
                </simple>
            </recipientList>
            <choice>

                <when>
                    <simple>
                        ${headers.CamelExecExitValue} == 0
                    </simple>

                    <setBody><simple>${header.CamelFileNameProduced}.swf</simple></setBody>
                    <to uri="reader:file"/>
                    <to uri="fedora:addDatastream?name=OBJ.swf&amp;type=application/x-shockwave-flash&amp;group=M&amp;dsLabel=Flexpaper&amp;versionable=false"/>

                    <recipientList> <!-- Delete the temporary SWF conversion file. Note: This approach is Unix specific. -->
                        <simple>
                            <!--
                            The conversion will fail if the picture is too complex.  The current decision is to log
                            the failure and just force the use of the PDF only.
                            -->
                            exec:rm?args=-f ${header.CamelFileNameProduced}.swf
                        </simple>
                    </recipientList>
                    <choice>
                       <when>
                           <simple>
                               ${headers.CamelExecExitValue} != 0
                           </simple>
                           <log message="${id} Derivatives: Unable to delete working file. Filename: ${headers.CamelFileNameProduced}.swf"
                                loggingLevel="WARN"/>
                           <!-- We also want to proactively tell monitoring -->
                       </when>
                    </choice>
                </when>

                <otherwise>
                    <log message="${id} Derivatives: Unable to convert PDF to SWF. PID: ${headers.CamelFedoraPid}  ${headers.CamelExecExitValue}"
                         loggingLevel="ERROR"/>
                </otherwise>

            </choice>

            <log message="${id} Derivatives: Finished PDF2SWF processing."
                 loggingLevel="DEBUG"
                 logName="edu.si.derivatives"/>
        </route>

        <route id="DerivativesProcessFITS">
            <from uri="direct:processDerivativesFITS"/>
            <log message="${id} Derivatives: Started FITS processing ..."
                 loggingLevel="DEBUG"
                 logName="edu.si.derivatives"/>

            <!-- Create a FITS derivative using Harvard FITS. -->
            <recipientList>
                <simple>
                    <!-- exec:fits?args=-i ${header.CamelFileNameProduced} -o ${header.CamelFileName.produced}.xml -->
                    exec:fits?args=-i ${header.CamelFileNameProduced}
                    <!-- exec:fits?args=RAW(-i <<< /dev/stdin) -->
                </simple>
            </recipientList>
            <choice>
                <!-- If FITS processing succeeded? Store a FITS datastream on the FDO. -->
                <when>
                    <simple>
                        ${headers.CamelExecExitValue} == 0
                    </simple>
                    <setHeader headerName="dsMIME">
                        <xpath resultType="java.lang.String">/fits:fits/fits:identification/fits:identity[1]/@mimetype</xpath>
                        <log message="${id} Derivatives: FITS MIME: ${headers.FITSmimeType}"
                             loggingLevel="DEBUG"
                             logName="edu.si.derivatives"/>
                    </setHeader>
                    <log message="${id} Derivatives: Exec FITS. BODY: ${body}"
                         loggingLevel="DEBUG"
                         logName="edu.si.derivatives"/>
                    <to uri="fedora:addDatastream?name=FITS&amp;type=text/xml&amp;dsLabel=FITS%20Generated%20Image%20Metadata&amp;group=X&amp;versionable=false"/>
                </when>
                <otherwise>
                    <log message="${id} Derivatives: FITS processing failed. PID: ${headers.CamelFedoraPid}  Error Code: ${headers.CamelExecExitValue}"
                         loggingLevel="ERROR"/>
                </otherwise>
            </choice>

            <log message="${id} Finished Derivatives FITS processing."
                 loggingLevel="DEBUG"
                 logName="edu.si.derivatives"/>
        </route>

        <route id="DerivativesProcessThumbnailator">
            <from uri="direct:processDerivativesThumbnailator"/>
            <log message="${id} Derivatives: Started Thumbnailator processing ..."
                 loggingLevel="DEBUG"
                 logName="edu.si.derivatives"/>

            <!-- Create a thumbnail derivative using the Thumbnailator library. -->
            <to uri="thumbnailator:image?keepRatio=false&amp;size=(200,150)"/>
            <to uri="fedora:addDatastream?name=TN&amp;type=image/jpg&amp;group=M&amp;dsLabel=Thumbnail&amp;versionable=false"/>

            <log message="${id} Derivatives: Finished Thumbnailator processing."
                 loggingLevel="DEBUG"
                 logName="edu.si.derivatives"/>
        </route>

        <route id="DerivativesProcessThumbnailImage" trace="true">
            <from uri="direct:processDerivativesThumbnailImage"/>
            <log message="${id} Derivatives: Started Thumbnail Image processing ..."
                 loggingLevel="DEBUG"
                 logName="edu.si.derivatives"/>

            <!--
                Making a call to camel:exec is less reliable and portable then using the Thumbnailator library.
                However, ImageMagick can create Thumbnails for formats that Thumbnailator cannot, for this case
                primarily PDF to JPG.  This route uses ImageMagick directly to create the thumbnail. The alternative
                is an intermediate JPG which takes a second step to accomplish.
            -->

            <!-- Create a thumbnail derivative using ImageMagick. -->
            <recipientList>
                <simple>
                    <!-- The arg tokenizer strips of the plus for profile. Workaround is to wrap all the args in RAW(). -->
                    <!-- exec:convert?args=RAW(-[0] -thumbnail 200x150 -colorspace RGB +profile * jpg:-) -->
                    <!-- Convert only the first page since the PDF may have multiple pages. -->
                    <!-- exec:convert?args= -[0] -thumbnail 200x150 -colorspace RGB jpg:- -->
                    exec:convert?args= -[0] -thumbnail 200x150 -colorspace RGB jpg:${header.CamelFileNameProduced}.jpg
                </simple>
            </recipientList>
            <choice>
                <when> <!-- If the conversion succeeded? Store the thumbnail image datastream on the FDO. -->
                    <simple>
                        ${headers.CamelExecExitValue} == 0
                    </simple>

                    <setBody><simple>${header.CamelFileNameProduced}.jpg</simple></setBody>
                    <to uri="reader:file"/>
                    <to uri="fedora:addDatastream?name=TN&amp;type=image/jpeg&amp;group=M&amp;dsLabel=Thumbnail&amp;versionable=false"/>

                    <recipientList> <!-- Delete the temporary JPG conversion file. Note: This approach is Unix specific. -->
                        <simple>
                            exec:rm?args=-f ${header.CamelFileNameProduced}.jpg
                        </simple>
                    </recipientList>
                    <choice>
                        <when>
                            <simple>
                                ${headers.CamelExecExitValue} != 0
                            </simple>
                            <log message="${id} Derivatives: Unable to delete working file. Filename: ${headers.CamelFileNameProduced}.jpg"
                                 loggingLevel="WARN"/>
                            <!-- We also want to proactively tell monitoring. -->
                        </when>
                    </choice>
                </when>
                <otherwise>
                    <log message="${id} Derivatives: Unable to create thumbnail image. PID: ${headers.CamelFedoraPid}  Error Code: ${headers.CamelExecExitValue}"
                         loggingLevel="ERROR"/>
                </otherwise>
            </choice>

            <log message="${id} Derivatives: Finished Thumbnail Image processing."
                 loggingLevel="DEBUG"
                 logName="edu.si.derivatives"/>
        </route>

    </camelContext>
    
</blueprint>
